---
title: Query Agent で E-Commerce アシスタントを構築する
sidebar_label: "Tutorial: E-Commerce assistant"
description: "Query Agent を使用して、商品およびブランドの質問に回答する e-commerce アシスタントを作成するチュートリアル。"
sidebar_position: 40
image: og/docs/tutorials.jpg
# tags: ['basics']
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import FilteredTextBlock from "@site/src/components/Documentation/FilteredTextBlock";
import PyCode from "!!raw-loader!/docs/agents/_includes/query_agent_tutorial_ecommerce.py";

このチュートリアルでは、 **[Weaviate Query Agent](./index.md)** を使ってシンプルな e-commerce アシスタント エージェントを構築します。このエージェントは複数の Weaviate コレクションにアクセスでき、各コレクションの情報を利用してブランドや衣料品に関する複雑な問い合わせに回答できます。

Query Agent を試せるように、いくつかの公開データセットを用意しました。  
HuggingFace で公開されています。

- [**E-Commerce：**](https://huggingface.co/datasets/weaviate/agents/viewer/query-agent-ecommerce) 衣料品、価格、ブランド、レビューなどをまとめたデータセットです。
- [**Brands：**](https://huggingface.co/datasets/weaviate/agents/viewer/query-agent-brands) 親ブランド、子ブランド、平均評価など、衣料品ブランドに関する情報をまとめたデータセットです。

## 導入： Query エージェントとは

Weaviate Query Agent は、Weaviate Cloud に保存されたデータにもとづいて自然言語の質問に回答するためにあらかじめ構築されたエージェント サービスです。ユーザーは自然言語でプロンプトや質問を入力するだけで、Query Agent が途中の処理をすべて担い、回答を返します。

import WeaviateAgentsECommerceFlowchart from "/docs/agents/_includes/query_agent_tutorial_ecommerce_flowchart.png";

<div class="row">
  <div class="card">
    <div class="card__image">
      <img
        src={WeaviateAgentsECommerceFlowchart}
        alt="Weaviate Query Agent flowchart"
      />
    </div>
  </div>
</div>
<br />

Query Agent の流れは次のとおりです。

1. 質問や instructions という形で **タスクを受け取る**  
2. **適切な生成モデル**（例：大規模言語モデル）を使ってタスクを解析し、実行すべき正確なクエリを決定する  
3. **Weaviate へクエリを送信**。必要に応じて指定されたベクトライザー統合（ここでは Weaviate Embeddings）でクエリをベクトル化する  
4. **Weaviate から結果を受け取り**、適切な生成モデルを使ってユーザーのプロンプト／質問に対する最終的な回答を生成する  

<hr />

## 前提条件

Weaviate Agents と Weaviate Embedding サービスを利用するには、 **[Weaviate Cloud](https://console.weaviate.cloud)** アカウントが必要です。

## ステップ 1: Weaviate のセットアップ

ここからは、本チュートリアルで使用する Weaviate Cloud インスタンスを作成し、Python クライアントと接続していきます。

### 1.1 Weaviate Cloud クラスターの作成

1. Weaviate Cloud で [無料の Sandbox クラスターを作成](/cloud/manage-clusters/create#sandbox-clusters) します。  
1. クラスターへ接続するために `REST Endpoint` と `Admin` API キーをメモします。（詳細は [クイックスタート](/cloud/manage-clusters/connect.mdx) をご覧ください）

:::tip
このチュートリアルではベクトライザーとして [Weaviate Embeddings](/weaviate/model-providers/weaviate/embeddings.md) サービスを使用するため、外部エンベディング プロバイダー用の追加キーは不要です。Weaviate Embeddings はデフォルトで `Snowflake/snowflake-arctic-embed-l-v2.0` モデルを利用します。<br/><br/>
別のベクトライザーを使用したい場合は、サポートされている [model providers](../../weaviate/model-providers/index.md) をご確認ください。
:::

### 1.2 Python ライブラリのインストール

Weaviate Python クライアントと `agents` コンポーネントをインストールするには、次を実行します。

<Tabs groupId="languages">
<TabItem value="py_agents" label="Python">

```
pip install "weaviate-client[agents]"
```

</TabItem>
</Tabs>

また、HuggingFace にホストされている公開データセットへアクセスするために軽量ライブラリ `datasets` も必要です。

<Tabs groupId="languages">
<TabItem value="py_agents" label="Python">

```
pip install datasets
```

</TabItem>
</Tabs>

import ForcePipInstall from "../_includes/_force_pip_install.mdx";

<ForcePipInstall />

### 1.3 インスタンスへの接続

それでは、最初のステップで取得したパラメーターを使って Weaviate Cloud インスタンスへ接続してみましょう。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START ConnectToWeaviate"
      endMarker="# END ConnectToWeaviate"
      language="py"
    />
  </TabItem>
</Tabs>

スニペットを実行すると `True` が表示され、インスタンスへの接続が成功したことを確認できます。

## ステップ 2: コレクションの準備

以下のコード ブロックでは、Hugging Face からデモ データセットを取得し、Weaviate Sandbox クラスターに新しいコレクションとして書き込みます。データを Weaviate にインポートする前に **コレクションを定義** し、データ スキーマを設定し、ベクトライザー／エンベディング サービスを選択する必要があります。

### 2.1 コレクションの定義

下記は `E-Commerce` と `Brands` データセット内のオブジェクト例です。

import WeaviateAgentsEcommerceDataset from "/docs/agents/_includes/query_agent_tutorial_ecommerce_dataset.png";

<div class="row">
  <div class="card">
    <div class="card__image">
      <img
        src={WeaviateAgentsEcommerceDataset}
        alt="The E-Commerce and Brands datasets"
      />
    </div>
  </div>
</div>
<br />

`Brands` コレクションでは、インポートされたデータにもとづいてプロパティを自動生成する [`auto-schema`](../../weaviate/config-refs/collections.mdx#auto-schema) オプションを使用します。  
ただし、これは最適なインポート方法とは言えません。

Query Agent は **コレクションとプロパティの説明** を参照して、クエリを解決する際にどれを使用するか判断します。説明を変更して詳細を追加し、挙動を試してみると良いでしょう。  
そのため、データ スキーマを手動で定義し、プロパティ説明を追加することを推奨します。

たとえば、以下の例では価格がすべて USD であることを Query Agent に明示しています。これは自動では取得できない情報です。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START DefineCollections"
      endMarker="# END DefineCollections"
      language="py"
    />
  </TabItem>
</Tabs>



### 2.2 データベースの入力

ここでは、あらかじめベクトル化されたデータ（[E-Commerce](https://huggingface.co/datasets/weaviate/agents/viewer/query-agent-ecommerce) と [Brands](https://huggingface.co/datasets/weaviate/agents/viewer/query-agent-brands)）を Weaviate Cloud インスタンスにインポートできます:

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START PopulateDatabase"
      endMarker="# END PopulateDatabase"
      language="py"
    />
  </TabItem>
</Tabs>

コレクションに対して `len()` を呼び出すことで、インポートが正常に完了したか、またコレクションのサイズを確認できます。

```
Size of the E-Commerce dataset: 448
Size of the Brands dataset: 104
```

## Step 3: Query エージェントの設定

### 3.1 基本的な Query エージェント

Query エージェントをセットアップする際には、次の項目を指定する必要があります:

- `client`
- エージェントにアクセスさせたい `collections`
- （任意）エージェントの振る舞いを説明する `system_prompt`
- （任意）タイムアウト - 既定値は 60 s

まずはシンプルなエージェントから始めます。`Brands` と `ECommerce` データセットにアクセスできる `qa` エージェントを作成します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START BasicQueryAgent"
      endMarker="# END BasicQueryAgent"
      language="py"
    />
  </TabItem>
</Tabs>

これだけで完了です。すぐに Query エージェントを使用できます。

### 3.2 カスタム Query エージェント（system prompt 付き） {#system-prompt-agent}

場合によっては、エージェント用にカスタムの `system_prompt` を定義したいことがあります。これにより、エージェントのデフォルトの振る舞いを指示できます。例として、常にユーザーの言語で回答するエージェントを作成してみましょう。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START CustomizedQueryAgent"
      endMarker="# END CustomizedQueryAgent"
      language="py"
    />
  </TabItem>
</Tabs>

このカスタム エージェント `multi_lingual_qa` は [step 4.5](#use-system-prompt-agent) で使用します。

## Step 4: Query エージェントの実行

エージェントを実行すると、クエリに応じて次のような判断を行います:

1. どのコレクション（複数可）を参照して回答を検索するかを判断します。  
2. 通常の **検索クエリ** を行うか、どの **フィルター** を使うか、**集約クエリ** を実行するか、あるいはそれらを組み合わせるかを判断します。  
3. その後、`QueryAgentResponse` 内にレスポンスを返します。  

### 4.1 質問をする

まずは簡単な質問から始めましょう:

- 「ビンテージの服が好きなのですが、200 ドル以下でいくつか候補を挙げてもらえますか？」

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START AskQuestions"
      endMarker="# END AskQuestions"
      language="py"
    />
  </TabItem>
</Tabs>

エージェントからのレスポンス:

```
original_query='I like vintage clothes, can you list me some options that are less than $200?' collection_names=['ECommerce'] searches=[[QueryResultWithCollection(queries=['vintage clothes'], filters=[[IntegerPropertyFilter(property_name='price', operator=<ComparisonOperator.LESS_THAN: '<'>, value=200.0)]], filter_operators='AND', collection='ECommerce')]] aggregations=[] usage=Usage(requests=3, request_tokens=7681, response_tokens=428, total_tokens=8109, details=None) total_time=11.588264226913452 aggregation_answer=None has_aggregation_answer=False has_search_answer=True is_partial_answer=False missing_information=[] final_answer='Here are some vintage-inspired clothing options under $200:\n\n1. **Vintage Philosopher Midi Dress ($125.00)** - A deep green velvet fabric dress with antique gold button detailing, perfect for an academic or sophisticated setting. [Echo & Stitch]\n\n2. **Vintage Gale Pleated Dress ($120.00)** - A burgundy pleated dress capturing the Dark Academia aesthetic, great for poetry readings or contemplative afternoons. [Solemn Chic]\n\n3. **Retro Groove Flared Pants ($59.00)** - Electric blue flared pants capturing early 2000s millennial pop culture chic. [Vivid Verse]\n\n4. **Vintage Scholar Tote ($90.00)** - A deep green canvas tote with brown leather accents, ideal for carrying scholarly essentials. [Echo & Stitch]\n\n5. **Retro Futura Tee ($29.98)** - A bold graphic tee with early 2000s pop culture references, perfect for a nostalgic throwback. [Vivid Verse]\n\n6. **Electric Velvet Trousers ($60.00)** - Neon green velvet trousers with a flared leg, inspired by turn-of-the-century fashion icons. [Vivid Verse]\n\n7. **Vintage Ivy Loafers ($120.00)** - Burgundy leather loafers offering timeless sophistication, suitable for academic settings. [Solemn Chic]' sources=[Source(object_id='6040c373-9cce-421d-8f4e-e01346cbf29f', collection='ECommerce'), Source(object_id='06a83da4-92ff-4cbc-9cc6-c55fc6ed49b9', collection='ECommerce'), Source(object_id='a5a0927d-2859-47e6-8455-d77e0190aa53', collection='ECommerce'), Source(object_id='a5f3c394-d207-4064-a2bc-b9f655d09ddc', collection='ECommerce'), Source(object_id='5d7bb719-2df5-4a7c-9bbc-275450ab29c6', collection='ECommerce'), Source(object_id='50f4c89c-faf9-4430-b393-c39ede5d511d', collection='ECommerce'), Source(object_id='5b6d5a1f-e218-4400-ac9f-df59466f3c97', collection='ECommerce')]
```

しかし、この出力は情報量が多すぎるため、`final_answer` フィールドだけを返すようにしてみましょう:

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START FinalAnswerAskQuestions"
      endMarker="# END FinalAnswerAskQuestions"
      language="py"
    />
  </TabItem>
</Tabs>

出力は次のとおりです:

```
Here are some vintage-inspired clothing options under $200:

1. **Vintage Philosopher Midi Dress ($125.00)** - A deep green velvet fabric dress with antique gold button detailing, perfect for an academic or sophisticated setting. [Echo & Stitch]

2. **Vintage Gale Pleated Dress ($120.00)** - A burgundy pleated dress capturing the Dark Academia aesthetic, great for poetry readings or contemplative afternoons. [Solemn Chic]

3. **Retro Groove Flared Pants ($59.00)** - Electric blue flared pants capturing early 2000s millennial pop culture chic. [Vivid Verse]

4. **Vintage Scholar Tote ($90.00)** - A deep green canvas tote with brown leather accents, ideal for carrying scholarly essentials. [Echo & Stitch]

5. **Retro Futura Tee ($29.98)** - A bold graphic tee with early 2000s pop culture references, perfect for a nostalgic throwback. [Vivid Verse]

6. **Electric Velvet Trousers ($60.00)** - Neon green velvet trousers with a flared leg, inspired by turn-of-the-century fashion icons. [Vivid Verse]

7. **Vintage Ivy Loafers ($120.00)** - Burgundy leather loafers offering timeless sophistication, suitable for academic settings. [Solemn Chic]
```

`QueryAgentResponse` に対して `display()` メソッドを使用すると、次の情報をユーザーフレンドリーな形式で確認できます:

- 🔍 元のクエリ - `original_query`
- 📝 最終回答 - `final_answer`
- 🔭 実行された検索 - `searches`
- 📊 実行された集約 - `aggregations`
- 📚 参照元 - `sources`
- ⚠️ 不足している情報 - `missing_information`
- 📊 使用状況統計 - `usage`
- 合計処理時間 - `total_time`

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START PrintQueryAgentResponseAskQuestions"
      endMarker="# END PrintQueryAgentResponseAskQuestions"
      language="py"
    />
  </TabItem>
</Tabs>

<details>
  <summary>The response is:</summary>

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔍 Original Query ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ I like vintage clothes, can you list me some options that are less than $200?                                                                                                                                                                     │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📝 Final Answer ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ Here are some vintage-inspired clothing options under $200:                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                   │
│ 1. **Vintage Philosopher Midi Dress ($125.00)** - A deep green velvet fabric dress with antique gold button detailing, perfect for an academic or sophisticated setting. [Echo & Stitch]                                                          │
│                                                                                                                                                                                                                                                   │
│ 2. **Vintage Gale Pleated Dress ($120.00)** - A burgundy pleated dress capturing the Dark Academia aesthetic, great for poetry readings or contemplative afternoons. [Solemn Chic]                                                                │
│                                                                                                                                                                                                                                                   │
│ 3. **Retro Groove Flared Pants ($59.00)** - Electric blue flared pants capturing early 2000s millennial pop culture chic. [Vivid Verse]                                                                                                           │
│                                                                                                                                                                                                                                                   │
│ 4. **Vintage Scholar Tote ($90.00)** - A deep green canvas tote with brown leather accents, ideal for carrying scholarly essentials. [Echo & Stitch]                                                                                              │
│                                                                                                                                                                                                                                                   │
│ 5. **Retro Futura Tee ($29.98)** - A bold graphic tee with early 2000s pop culture references, perfect for a nostalgic throwback. [Vivid Verse]                                                                                                   │
│                                                                                                                                                                                                                                                   │
│ 6. **Electric Velvet Trousers ($60.00)** - Neon green velvet trousers with a flared leg, inspired by turn-of-the-century fashion icons. [Vivid Verse]                                                                                             │
│                                                                                                                                                                                                                                                   │
│ 7. **Vintage Ivy Loafers ($120.00)** - Burgundy leather loafers offering timeless sophistication, suitable for academic settings. [Solemn Chic]                                                                                                   │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔭 Searches Executed 1/1 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ QueryResultWithCollection(queries=['vintage clothes'], filters=[[IntegerPropertyFilter(property_name='price', operator=<ComparisonOperator.LESS_THAN: '<'>, value=200.0)]], filter_operators='AND', collection='ECommerce')                       │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ 📊 No Aggregations Run                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📚 Sources ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│  - object_id='6040c373-9cce-421d-8f4e-e01346cbf29f' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='06a83da4-92ff-4cbc-9cc6-c55fc6ed49b9' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='a5a0927d-2859-47e6-8455-d77e0190aa53' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='a5f3c394-d207-4064-a2bc-b9f655d09ddc' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='5d7bb719-2df5-4a7c-9bbc-275450ab29c6' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='50f4c89c-faf9-4430-b393-c39ede5d511d' collection='ECommerce'                                                                                                                                                                        │
│  - object_id='5b6d5a1f-e218-4400-ac9f-df59466f3c97' collection='ECommerce'                                                                                                                                                                        │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯


   📊 Usage Statistics
┌────────────────┬──────┐
│ LLM Requests:  │ 3    │
│ Input Tokens:  │ 7681 │
│ Output Tokens: │ 428  │
│ Total Tokens:  │ 8109 │
└────────────────┴──────┘

Total Time Taken: 11.59s
```

</details>

### 4.2 フォローアップ質問

エージェントには追加のコンテキストを与えることもできます。たとえば、`ChatMessage` オブジェクトを使って前回の応答をコンテキストとして会話を構築し、`new_response` を取得できます:

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START FollowUpAskQuestions"
      endMarker="# END FollowUpAskQuestions"
      language="py"
    />
  </TabItem>
</Tabs>

<details>
  <summary>応答は次のとおりです:</summary>

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔍 Original Query ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ What about some nice shoes, same budget as before?                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📝 Final Answer ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ Here are some great vintage-style shoes priced under $200 from various collections that blend style with nostalgia:                                                                                                                               │
│                                                                                                                                                                                                                                                   │
│ 1. **Vintage Noir Loafers** ($125): These dress shoes, part of the Dark Academia collection, come in black and grey, offering a timeless look with subtle modern twists. They have received positive reviews for style and comfort, once broken   │
│ in (Source: 1).                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                   │
│ 2. **Vintage Ivy Loafers** ($120): Another classic from the Dark Academia line, these deep burgundy loafers combine elegance with comfort, as appreciated by users in their reviews (Source: 2).                                                  │
│                                                                                                                                                                                                                                                   │
│ 3. **Glide Platforms** ($90): For a more playful option, these high-shine pink platform sneakers offer a nod to the Y2K era, receiving praise for their comfort and unique look (Source: 3).                                                      │
│                                                                                                                                                                                                                                                   │
│ 4. **Celestial Step Platform Sneakers** ($90): With a dreamy sky blue color, these Y2K-inspired sneakers provide comfort and a touch of whimsy (Source: 4).                                                                                       │
│                                                                                                                                                                                                                                                   │
│ 5. **Garden Stroll Loafers** ($90): From the Cottagecore collection, these cream loafers feature delicate floral motifs for a chic, countryside-inspired look (Source: 5).                                                                        │
│                                                                                                                                                                                                                                                   │
│ 6. **Bramble Brogues** ($120): In dusky green, these suede brogues add pastoral elegance to any outfit, admired for their craftsmanship (Source: 7).                                                                                              │
│                                                                                                                                                                                                                                                   │
│ 7. **Garden Fête Heels** ($125): These cottagecore heels feature floral embroidery for a touch of elegance perfect for garden parties (Source: 10).                                                                                               │
│                                                                                                                                                                                                                                                   │
│ 8. **Garden Gala T-Straps** ($125): Elegant cream and sage T-strap heels featuring floral embellishments, perfect for a whimsical yet classy touch (Source: 18).                                                                                  │
│                                                                                                                                                                                                                                                   │
│ All these options fall under the $200 budget, offering a variety of styles from classic and elegant to colorful and playful, accommodating different fashion tastes and preferences.                                                              │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔭 Searches Executed 1/1 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ QueryResultWithCollection(queries=['vintage shoes'], filters=[[IntegerPropertyFilter(property_name='price', operator=<ComparisonOperator.LESS_THAN: '<'>, value=200.0)]], filter_operators='AND', collection='Ecommerce')                         │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────── 📊 Aggregations Run 1/1 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ AggregationResultWithCollection(                                                                                                                                                                                                                  │
│     search_query=None,                                                                                                                                                                                                                            │
│     groupby_property=None,                                                                                                                                                                                                                        │
│     aggregations=[IntegerPropertyAggregation(property_name='price', metrics=<NumericMetrics.MEAN: 'MEAN'>)],                                                                                                                                      │
│     filters=[TextPropertyFilter(property_name='subcategory', operator=<ComparisonOperator.LIKE: 'LIKE'>, value='vintage')],                                                                                                                       │
│     collection='Ecommerce'                                                                                                                                                                                                                        │
│ )                                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📚 Sources ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│  - object_id='92efe1bb-77ee-4002-8618-4c9d7c3972c2' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='f51001bf-c0c6-47d5-b165-4e7ce878900e' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='9ba9ed81-c917-4e13-8058-d6ad81896ef3' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='41f324c2-a8e8-4cde-87d0-42661435a32c' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='d8d8e59e-d935-4a6f-9df1-bc2477452b11' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='505238e0-9993-4838-89fc-513c8f53d9f8' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='4a1321dc-d3f5-405d-8b21-e656c448ccfd' collection='Ecommerce'                                                                                                                                                                        │
│  - object_id='b59f7700-2633-43d6-807e-72dda35d545c' collection='Ecommerce'                                                                                                                                                                        │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯


   📊 Usage Statistics
┌────────────────┬───────┐
│ LLM Requests:  │ 5     │
│ Input Tokens:  │ 15998 │
│ Output Tokens: │ 906   │
│ Total Tokens:  │ 16904 │
└────────────────┴───────┘

Total Time Taken: 22.77s
```

</details>

### 4.3 集約の実行

ここでは、集約が必要な質問を試してみましょう。どのブランドが最も多くのシューズを掲載しているかを確認します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START Aggregation"
      endMarker="# END Aggregation"
      language="py"
    />
  </TabItem>
</Tabs>

<details>
  <summary>応答は次のとおりです:</summary>

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔍 Original Query ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ What is the the name of the brand that lists the most shoes?                                                                                                                                                                                      │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📝 Final Answer ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ The brand that lists the most shoes is Loom & Aura, with a total count of 118 shoes across various styles such as Cottagecore, Fairycore, Goblincore, Light Academia, and Dark Academia.                                                          │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ 🔭 No Searches Run                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────── 📊 Aggregations Run 1/1 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ AggregationResultWithCollection(                                                                                                                                                                                                                  │
│     search_query=None,                                                                                                                                                                                                                            │
│     groupby_property='brand',                                                                                                                                                                                                                     │
│     aggregations=[TextPropertyAggregation(property_name='collection', metrics=<TextMetrics.TOP_OCCURRENCES: 'TOP_OCCURRENCES'>, top_occurrences_limit=1)],                                                                                        │
│     filters=[],                                                                                                                                                                                                                                   │
│     collection='ECommerce'                                                                                                                                                                                                                        │
│ )                                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯


   📊 Usage Statistics
┌────────────────┬──────┐
│ LLM Requests:  │ 3    │
│ Input Tokens:  │ 5794 │
│ Output Tokens: │ 238  │
│ Total Tokens:  │ 6032 │
└────────────────┴──────┘

Total Time Taken: 7.52s
```

</details>

### 4.4 複数コレクションの検索

場合によっては、複数のコレクションにわたる検索結果を組み合わせる必要があります。上記の結果から、「Loom & Aura」が最も多くのシューズを掲載していることがわかります。

次に、ユーザーがこの企業について、_さらに_ その販売商品について詳しく知りたいというシナリオを想定してみましょう。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START SearchOverMultipleCollections"
      endMarker="# END SearchOverMultipleCollections"
      language="py"
    />
  </TabItem>
</Tabs>

<details>
  <summary>応答は次のとおりです:</summary>

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔍 Original Query ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ Does the brand 'Loom & Aura' have a parent brand or child brands and what countries do they operate from? Also, what's the average price of a shoe from 'Loom & Aura'?                                                                            │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📝 Final Answer ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ The brand "Loom & Aura" operates as a parent brand with several child brands, including "Loom & Aura Active," "Loom & Aura Kids," "Nova Nest," "Vivid Verse," "Loom Luxe," "Saffrom Sage," "Stellar Stitch," "Nova Nectar," "Canvas Core," and    │
│ "Loom Lure." "Loom & Aura" itself is based in Italy and operates in multiple countries where its child brands are located, such as the USA, Japan, South Korea, Spain, the UK, and France.                                                        │
│                                                                                                                                                                                                                                                   │
│ The average price of a shoe from "Loom & Aura" is approximately $87.11, based on the aggregation of available data on shoe prices.                                                                                                                │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔭 Searches Executed 1/2 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ QueryResultWithCollection(queries=['Loom parent brand and child brands', 'Aura parent brand and child brands'], filters=[[], []], filter_operators='AND', collection='Brands')                                                                    │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────── 🔭 Searches Executed 2/2 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ QueryResultWithCollection(queries=['countries where Loom & Aura operates'], filters=[[TextPropertyFilter(property_name='name', operator=<ComparisonOperator.EQUALS: '='>, value='Loom & Aura')]], filter_operators='AND', collection='Brands')    │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────── 📊 Aggregations Run 1/1 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│ AggregationResultWithCollection(                                                                                                                                                                                                                  │
│     search_query='',                                                                                                                                                                                                                              │
│     groupby_property=None,                                                                                                                                                                                                                        │
│     aggregations=[IntegerPropertyAggregation(property_name='price', metrics=<NumericMetrics.MEAN: 'MEAN'>)],                                                                                                                                      │
│     filters=[TextPropertyFilter(property_name='brand', operator=<ComparisonOperator.EQUALS: '='>, value='Loom')],                                                                                                                                 │
│     collection='Ecommerce'                                                                                                                                                                                                                        │
│ )                                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 📚 Sources ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                                                                                                                                                                                                                   │
│  - object_id='cb022de3-36ac-4ab9-94c6-cddbbebbb035' collection='Brands'                                                                                                                                                                           │
│                                                                                                                                                                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯


   📊 Usage Statistics
┌────────────────┬───────┐
│ LLM Requests:  │ 5     │
│ Input Tokens:  │ 11158 │
│ Output Tokens: │ 608   │
│ Total Tokens:  │ 11766 │
└────────────────┴───────┘

Total Time Taken: 16.12s
```

</details>

### 4.5 システムプロンプトの利用 {#use-system-prompt-agent}

ここでは、[ステップ 3.2](#system-prompt-agent) で作成したカスタム エージェントを、次のシステムプロンプトと共に使用します:

```
"You are a helpful assistant that always generates the final response in the user's language."
"You may have to translate the user query to perform searches. But you must always respond to the user in their own language."
```

たとえば、ブランド「Eko & Stitch」が英国に支店や関連会社を持っているかどうかを、日本語で質問してみてください（英語ではなく）:

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START MoreQuestions"
      endMarker="# END MoreQuestions"
      language="py"
    />
  </TabItem>
</Tabs>

<details>
  <summary>応答は次のとおりです:</summary>

```
Eko & Stitchは、英国に拠点があります。1974年に設立され、品質の高いクラフトマンシップとタイムレスなエレガンスで知られています。関連ブランドとして「Eko & Stitch Active」と「Eko & Stitch Kids」があります。また、Eko & Stitchの親会社はNova Nestです。
```

英訳すると:

```
Eko & Stitch is based in the UK. It was established in 1974 and is known for its high-quality craftsmanship and timeless elegance. It has associated brands, "Eko & Stitch Active" and "Eko & Stitch Kids." Additionally, the parent company of Eko & Stitch is Nova Nest.
```

</details>

## 概要

このガイドでは、Weaviate のエージェントサービスを活用して、エンドツーエンドの e-commerce アシスタントを構築する方法を説明しました。具体的には、Weaviate Cloud インスタンスのセットアップやデータセットのインポートから、自然言語クエリをインテリジェントに処理する Query Agent の設定までを扱いました。

Query Agent はクエリを自動的に解釈し、標準検索・フィルター・集約のどれを実行するかを判断します。また、複数のコレクションに接続し、クエリに応じて適切なソースを選択します。さらに、過去のやり取りを利用して関連性の高いフォローアップ回答を提供でき、システムプロンプトを定義することで、常にユーザーの好む言語やスタイルで応答させることも可能です。

## 関連リソース

- [Weaviate Agents ‐ Query Agent](./index.md)

## ご質問とフィードバック

import DocsFeedback from "/_includes/docs-feedback.mdx";

<DocsFeedback />

