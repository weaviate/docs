---
title: コレクションのスケーリング制限
sidebar_label: コレクションのスケーリング制限
sidebar_position: 1
image: og/docs/more-resources.jpg
# tags: ['performance']
---

:::info **`v1.30`** で追加
:::

:::caution コレクション数の上限に達しましたか？
コレクション数の上限に達したというエラーが表示された場合、**これ以上コレクションを作成することはできません**。この上限は、Weaviate のパフォーマンスを保つためのものです。既に上限を超えているインスタンスでは、新しいコレクションの作成は許可されませんが、既存のコレクションが削除されることはありません。<br /><br />
**単純に上限を引き上げるのではなく、アーキテクチャを再検討することをお勧めします。** どうしても上限を変更する必要がある場合は、[`MAXIMUM_ALLOWED_COLLECTIONS_COUNT`](/deploy/configuration/env-vars/index.md) 環境変数を使用してください。
:::

このガイドでは、**マルチテナンシー**を利用するか、データセットごとに**専用コレクション**を定義するかというアーキテクチャの選択肢について概説します。

たとえば、開発者が SaaS プラットフォームを構築し、エンドユーザー（販売者）が自分の顧客に商品を推薦できるようにするケースを考えます。このとき、各販売者は自分のデータのみをアップロードして扱います。

1 つの選択肢として、開発者が販売者ごとに専用のコレクションを作成する方法があります。しかし、販売者の数が増えるにつれてコレクション数も増え、パフォーマンスのボトルネックや運用の複雑化が生じる可能性があります。そこで重要になるのが、**「マルチテナンシー」**と**「データセットごとに 1 コレクション」**のどちらを採用すべきかというアーキテクチャ上の判断です。

## 最適なアーキテクチャの選択

import MultiTenanyVsMultipleCollections from '/docs/weaviate/starter-guides/img/weaviate-multi-tenancy-vs-multiple-collections.png';

<div class="row">
  <div class="card">
    <div class="card__image">
      <img
        src={MultiTenanyVsMultipleCollections}
        alt='Multi-tenancy vs "One collection per dataset" architecture'
      />
    </div>
  </div>
</div>
<br />

Weaviate でベクトルデータベースのコレクション定義（データスキーマ）を設計する際、**マルチテナンシー**（複数テナントのデータを 1 つのコレクションに格納）と、**データセットごとに専用コレクションを作成**（「データセットごとに 1 コレクション」戦略）のいずれかを選択する必要があります。各アプローチには、パフォーマンス、スケーラビリティ、および管理面でそれぞれ利点とトレードオフがあります。

本ガイドでは、それぞれの概念を明確にし、利点と欠点に焦点を当てて解説します。

- **["データセットごとに 1 コレクション" アーキテクチャ](#one-collection-per-dataset-architecture)**
- **[マルチテナンシー アーキテクチャ](#multi-tenancy-architecture)**

### "データセットごとに 1 コレクション" アーキテクチャ

この方式では、**各データセットに専用コレクション**を割り当てることで、データを相互に分離します。マルチテナンシーが Weaviate に実装される前は、複数データセットを扱う最良の方法でした。

import MultipleCollectionsExample from '/docs/weaviate/starter-guides/img/weaviate-multiple-collections-example.png';

<div class="row">
  <div class="col col--4">
    <p>
      書店がプラットフォームに登録すると、<code>BookStoreProducts</code> コレクションを作成します。これにより、著者、タイトル、ジャンルなど、
      その EC プラットフォーム固有のプロパティを追加できます。
      <br />
      <br />
      データセットごとに新しいコレクション（<code>ShoeStoreProducts</code>、<code>
        GameStoreProducts
      </code> など）を作成する方法は、データ分離を維持するシンプルで効果的なやり方に思えます。しかしプラットフォームがスケールすると、この方法はすぐに重大な課題に直面します。
    </p>
  </div>
  <div class="col col--8">
    <div class="card">
      <div class="card__image">
        <img
          src={MultipleCollectionsExample}
          alt='"One collection per dataset" architecture example'
        />
      </div>
      <div class="card__body">
        "データセットごとに 1 コレクション" アーキテクチャの例
      </div>
    </div>
  </div>
</div>
<br />

#### 利点

- **カスタマイズ性**: コレクション定義の変更や最適化を、他のコレクションに影響を与えず個別に行えます。
- **データ分離**: 専用コレクションにより、データセットが完全に分離されます。

#### 課題

- **リソースのオーバーヘッド**: 各コレクションは独自の定義、インデックス、およびストレージを必要とし、メモリとディスクの使用量が増加します。何千、何百万というコレクションの管理はほぼ不可能です。
- **運用の複雑さ**: コレクション定義の変更を各コレクションに個別適用する必要があります。各コレクションを個別に更新するため、多大な時間と計算リソースがかかります。

:::tip
`20` 個以上のコレクションを作成する場合は、マルチテナンシーの利用を検討してください。
:::

### マルチテナンシー アーキテクチャ

マルチテナンシーとは、1 つのコレクションを複数のデータセット（テナント）に分割して使用することです。テナント名によって各テナントのデータが論理的に分離されます。複数顧客のデータを保存したい場合や、複数プロジェクトで同様の構造のデータを扱いたい場合に特に有用です。

import MultiTenancyExample from '/docs/weaviate/starter-guides/img/weaviate-multi-tenancy-example.png';

<div class="row">
  <div class="col col--4">
    <br />
    <p>
      各テナントは名前で識別され、同じコレクション内でも論理的に分離された状態が保たれます。書店がプラットフォームに登録するときは、<code>Products</code> コレクションに <code>BookStore</code> という新しいテナントを作成できます。
      <br />
      <br />
      クエリは名前でフィルタリングして、関連するデータのみを取得することも可能です。
    </p>
  </div>
  <div class="col col--8">
    <div class="card">
      <div class="card__image">
        <img
          src={MultiTenancyExample}
          alt="Multi-tenancy architecture example"
        />
      </div>
      <div class="card__body">マルチテナンシー アーキテクチャの例</div>
    </div>
  </div>
</div>
<br />
#### 利点

多数のテナントをサポートしつつ、リソース効率とスケーラビリティを重視する場合は、マルチテナンシーを使用してください。

- **コレクション定義の管理が容易:** 定義を更新するとすべてのテナントに一括で適用されます。たとえば、すべての商品に新しいプロパティを追加する作業がはるかに簡単になります。  
- **インデックスのスケーラビリティ:** インデックスを複数のコレクションに分割せず、単一のコレクション用に最適化できます。各テナントには専用の高性能 ベクトル インデックスが割り当てられるため、クエリ速度が向上します。共有インデックス空間を検索する代わりに、各テナントはクラスター上で唯一のユーザーであるかのように応答します。  
- **データ分離:** 各テナントのデータは完全に分離されています。これにより、データ削除もはるかに容易かつ高速になります。

#### 課題

- **アクセス制御の複雑さ:** テナント間のデータ分離を保証するために、[きめ細かなアクセス制御](/deploy/configuration/authorization.md) を実装する必要があります。  
- **コレクション定義の統一:** すべてのテナントが同じコレクション スキーマと設定を共有する必要があります。

:::tip ストレージコストの削減
リソースを節約するため、[テナントの state](../managing-resources/tenant-states.mdx) を `inactive`（ローカルディスクに保存）または `offloaded`（クラウドストレージに保存）に変更できます。

<br />

マルチテナンシーの管理については、[How-to: マルチテナンシー操作](../../manage-collections/multi-tenancy.mdx) を参照してください。
:::

## 結論

マルチテナンシーと専用コレクションのどちらを選択するかはユースケースによって異なりますが、マルチテナンシーには大きなパフォーマンス上の利点があり、ほとんどのシナリオで推奨されます。マルチテナンシーを利用すると、インデックス作成のオーバーヘッドを削減し、テナント全体でのコレクション定義の更新を簡素化することで、大幅なリソース効率を得られます。

専用コレクションはケースによってはより高度なデータ分離と柔軟性を提供できますが、運用の複雑さとリソース要求の増大がこれらの利点を上回ることがよくあります。クエリ性能、インデックスサイズ、リソース使用率を定期的に監視し、アーキテクチャを微調整することが、現在および将来のニーズを満たすうえで不可欠です。

## 参考リソース

マルチテナンシーの詳細については、次のページをご覧ください。

- [How-to: マルチテナンシー操作](../../manage-collections/multi-tenancy.mdx)
- [How-to: テナント state の管理](../../manage-collections/tenant-states.mdx)

## 質問とフィードバック

import DocsFeedback from '/_includes/docs-feedback.mdx';

<DocsFeedback />