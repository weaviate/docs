---
title: v2 から v3 への移行
sidebar_position: 70
description: TypeScript アプリケーションを v2 から最新の v3 クライアントライブラリへ移行するためのアップグレードガイド。
image: og/docs/client-libraries.jpg
# tags: ['typescript', 'client library']
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import FilteredTextBlock from '@site/src/components/Documentation/FilteredTextBlock';
import TSv2Code from '!!raw-loader!/_includes/code/client-libraries/migrate-ts2.ts';
import TSv3Code from '!!raw-loader!/_includes/code/client-libraries/migrate-ts3.ts';
import TSv3Additional from '!!raw-loader!/_includes/code/client-libraries/migrate-additional-ts3.ts';
import TSv2Additional from '!!raw-loader!/_includes/code/client-libraries/migrate-additional-ts2.ts';

import TSClientIntro from '/_includes/clients/ts-client-intro.mdx';

<TSClientIntro />

## インストール

TypeScript クライアント v3 をインストールするには、次の手順に従ってください。

1. **Node.js を更新**

   v3 クライアントには `Node v18` 以上が必要です。

1. **新しいクライアントパッケージをインストール**

  ```bash
  npm install weaviate-client
  ```

1. **Weaviate をアップグレード**

   v3 クライアントには Weaviate Database `1.23.7` 以上が必要です。可能な限り、Weaviate Database と Weaviate クライアントの最新バージョンを使用してください。

1. **gRPC ポートを開放**

   デフォルトの gRPC ポートは 50051 です。

    <details>
      <summary>docker-compose.yml</summary>

    Docker コンテナ内の Weaviate gRPC ポートをローカルポートにマッピングするには、`docker-compose.yml` ファイルに次のコードを追加します。

    ```yaml
        ports:
        - 8080:8080
        - 50051:50051
    ```
    </details>

## クライアントの生成

`weaviate` オブジェクトは、すべての API 操作のメインエントリーポイントです。v3 クライアントは `weaviate` オブジェクトを生成し、あなたの Weaviate インスタンスへ [接続を作成](/weaviate/connections) します。

ほとんどの場合、接続ヘルパー関数のいずれかを使用して Weaviate インスタンスへ接続することを推奨します。

- `connectToWCD`
- `connectToLocal`
- `connectToCustom`

カスタム設定を使用して、クライアントを直接生成することもできます。

<Tabs groupId="connections">
<TabItem value="local" label="Local">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// ConnectLocal"
  endMarker="// END ConnectLocal"
  language="js"
/>
</TabItem>
<TabItem value="wcd" label="Weaviate Cloud">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// ConnectCloud"
  endMarker="// END ConnectCloud"
  language="js"
/>
</TabItem>
<TabItem value="custom" label="Custom">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// ConnectCustom"
  endMarker="// END ConnectCustom"
  language="js"
/>
</TabItem>
</Tabs>

## v3 の変更点

このセクションでは、TypeScript クライアント v3 の主な特徴を紹介します。

### 設計方針

v3 クライアントは、コレクションを通じて Weaviate データベース内のオブジェクトを操作することを中心に設計されています。

アプリケーションコードはコレクションを表すオブジェクトを作成し、そのオブジェクトを通じて検索や CRUD 操作を実行します。

次の例は `JeopardyQuestion` コレクションからオブジェクトを取得します。

```js
const myCollection = client.collections.use('JeopardyQuestion');

const result = await myCollection.query.fetchObjects()

console.log(JSON.stringify(result, null, 2));
```

### Node のみ対応

gRPC プロトコルは高速で、内部的にも多くの利点があります。しかし残念ながら、gRPC はブラウザベースのクライアント開発をサポートしていません。

v3 クライアントは gRPC を使用して Weaviate インスタンスへ接続します。そのため、クライアントは Node.js を用いたサーバーサイド開発をサポートし、ブラウザベースの Web クライアント開発はサポートしていません。

ブラウザベースのアプリケーションを開発する場合は、[v2 クライアント](/weaviate/client-libraries/typescript/typescript-v2) をご利用ください。

### コレクションの操作

v2 クライアントでは CRUD や検索操作に `client` オブジェクトを使用します。v3 クライアントでは、`client` オブジェクトの代わりに `collection` オブジェクトを使用します。

接続を作成した後は、各操作でコレクションを指定する必要がありません。これによりミスを減らせます。

<Tabs groupId="collections">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// CollectionEx"
  endMarker="// END CollectionEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// CollectionEx"
  endMarker="// END CollectionEx"
  language="js"
/>
</TabItem>
</Tabs>

`collection` オブジェクトはコードベース全体で再利用できます。



### ビルダー パターンの廃止

v2 クライアントはビルダー パターンを使用してクエリを構築します。ビルダー パターンはわかりにくく、無効なクエリを引き起こす可能性があります。

v3 クライアントではビルダー パターンを使用しません。その代わり、特定のメソッドとメソッド パラメーターを使用します。

<Tabs groupId="builderEx">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// BuilderEx"
  endMarker="// END BuilderEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// BuilderEx"
  endMarker="// END BuilderEx"
  language="js"
/>
</TabItem>
</Tabs>

### バッチ挿入

`insertMany()` メソッドは `objectBatcher()` を置き換え、バッチ挿入を簡単にします。

5,000 件を超えるオブジェクトを挿入する場合は、バッチ処理の一部として `insertMany()` を使用してください。

バッチ処理の詳細については、[バッチ挿入](../../manage-objects/import.mdx) を参照してください。

<Tabs groupId="batchEx">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// BatchEx"
  endMarker="// END BatchEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// BatchEx"
  endMarker="// END BatchEx"
  language="js"
/>
</TabItem>
</Tabs>

### クライアントの Close メソッド

import TSClientClose from '/_includes/clients/ts-client-close.mdx';

<TSClientClose />

### データのフィルタリング

`Filter` ヘルパー クラスにより、条件付きフィルターの利用が容易になります。v3 クライアントでは `Filter` の使用方法が簡素化され、コードがよりクリーンで簡潔になります。

<Tabs groupId="filterDataEx">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// FilterDataEx"
  endMarker="// END FilterDataEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// FilterDataEx"
  endMarker="// END FilterDataEx"
  language="js"
/>
</TabItem>
</Tabs>

### generate 名前空間

v3 クライアントでは生成クエリ用に新しい名前空間 `generate` が追加されました。これにより、生成クエリとベクトル検索を区別しやすくなります。

<Tabs groupId="generateNameEx">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// GenerateNamespaceEx"
  endMarker="// END GenerateNamespaceEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// GenerateNamespaceEx"
  endMarker="// END GenerateNamespaceEx"
  language="js"
/>
</TabItem>
</Tabs>

### 返却オブジェクト

新しいクライアントでは返却オブジェクトがよりシンプルになりました。オブジェクトの UUID、メタデータ、生成クエリの結果などの重要な情報に簡単にアクセスできます。

<Tabs groupId="returnObjEx">
<TabItem value="three" label="Client v3">
<FilteredTextBlock
  text={TSv3Additional}
  startMarker="// ReturnObjectEx"
  endMarker="// END ReturnObjectEx"
  language="js"
/>
</TabItem>
<TabItem value="two" label="Client v2">
<FilteredTextBlock
  text={TSv2Additional}
  startMarker="// ReturnObjectEx"
  endMarker="// END ReturnObjectEx"
  language="js"
/>
</TabItem>
</Tabs>



## コード比較

これらのサンプルでは、クライアント v2 コードと v3 コードを比較します。

比較用サンプルでは、両クライアントで共通するコード部分を省略しています。完全な v2 と v3 のクライアントスクリプトは[こちら](#sample-scripts)にあります。

### インポート

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// Imports"
  endMarker="// END Imports"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// Imports"
  endMarker="// END Imports"
  language="js"
/>
</TabItem>
</Tabs>

### Weaviate Cloud への接続

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// CreateClient"
  endMarker="// END CreateClient"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// CreateClient"
  endMarker="// END CreateClient"
  language="js"
/>
</TabItem>
</Tabs>

### コレクションの作成

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// CreateCollection"
  endMarker="// END CreateCollection"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// CreateCollection"
  endMarker="// END CreateCollection"
  language="js"
/>
</TabItem>
</Tabs>

### バッチ挿入

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// BatchInsert"
  endMarker="// END BatchInsert"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// BatchInsert"
  endMarker="// END BatchInsert"
  language="js"
/>
</TabItem>
</Tabs>

### データのクエリ実行

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// RunAQuery"
  endMarker="// END RunAQuery"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// RunAQuery"
  endMarker="// END RunAQuery"
  language="js"
/>
</TabItem>
</Tabs>

### コレクションの削除

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// DeleteCollection"
  endMarker="// END DeleteCollection"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// DeleteCollection"
  endMarker="// END DeleteCollection"
  language="js"
/>
</TabItem>
</Tabs>


### サンプルスクリプト

このセクションのクライアント比較コードを、完全な形で示したスクリプトです。

<Tabs groupId="languages">
<TabItem value="jsv3" label="Client v3">
<FilteredTextBlock
  text={TSv3Code}
  startMarker="// CompleteScript"
  endMarker="// END CompleteScript"
  language="js"
/>
</TabItem>
<TabItem value="jsv2" label="Client v2">
<FilteredTextBlock
  text={TSv2Code}
  startMarker="// CompleteScript"
  endMarker="// END CompleteScript"
  language="js"
/>
</TabItem>
</Tabs>

その他のコード例については、以下を参照してください。

- [検索](/weaviate/search)
- [コレクション管理](/weaviate/manage-collections)
- [Weaviate への接続](/weaviate/connections)

## コードの移行方法

v2 クライアントコードを v3 に更新するには、次の手順を行います。

1. [ v3 クライアントパッケージ](https://www.npmjs.com/package/weaviate-client) をインストールします。  
1. v2 コードを編集し、v3 クライアントパッケージを [インポート](/weaviate/client-libraries/typescript#import-the-client) します。  
1. v2 の [クライアント生成](/weaviate/client-libraries/typescript) コードを編集します。  
1. コードを編集し、[ collection first](#design-philosophy) のクライアント指向を反映させます。  

v2 のコードを v3 相当へすべて置き換えるまで、順次更新してください。

## クライアントの変更ログ

各リリースのクライアント [変更ログ](https://github.com/weaviate/typescript-client/releases) は GitHub で確認できます。

## 質問とフィードバック

import DocsFeedback from '/_includes/docs-feedback.mdx';

<DocsFeedback/>

