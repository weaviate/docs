---
title: ユースケース（動機）
sidebar_position: 1
description: "Weaviate のレプリケーションの利点と設定要件を示す 4 つの主要なユースケース。"
image: og/docs/concepts.jpg
# tags: ['architecture']
---

このページでは、 Weaviate のレプリケーションを導入する動機となる 4 つのユースケースを紹介します。目的が異なるため、それぞれに必要な設定も変わる場合があります。

## 高可用性（冗長化）

データベースの高可用性とは、サービスを中断することなく継続的に稼働できるよう設計されていることを意味します。つまり、障害やエラーが発生しても自動的に処理できる耐障害性が求められます。

これはレプリケーションによって解決できます。冗長ノードが存在すれば、ほかのノードが停止してもリクエストを処理できます。

Weaviate はクラスターメタデータ操作を重要視しており、データ操作とは異なる方法で扱います。

Weaviate `v1.25` からは、クラスターメタデータのレプリケーションに Raft コンセンサスアルゴリズムを採用しています。 Raft はリーダーベースのアルゴリズムで、リーダーノードがクラスターメタデータの変更を担当します。これにより、一部のノードが障害を起こしてもクラスターメタデータの整合性が保たれます。

Weaviate `v1.25` 以前は、クラスターメタデータ操作にリーダーレス設計と 2 フェーズコミットを使用していました。そのため、コレクション定義の更新やテナント状態の更新といったクラスターメタデータ操作にはすべてのノードが必要でした。ノードが一時的にダウンするとクラスターメタデータ操作が行えず、また同時に実行できるクラスターメタデータ操作は 1 件のみという制限もありました。

データ操作に関しては、分散データベース構成ではノードがダウンしても読み書きクエリが利用可能な場合があり、単一障害点は排除されます。ユーザーのクエリは利用可能なレプリカノードに自動的（かつ透過的に）ルーティングされます。

高可用性が求められるアプリケーションの例としては、救急サービス、企業向け IT システム、ソーシャルメディア、ウェブサイト検索などが挙げられます。現代のユーザーは高い可用性を当たり前と考えており、ほとんどダウンタイムを許容しません。たとえばウェブサイト検索では、ノードがダウンしてもサービス（読み取りクエリ）が停止してはいけません。書き込みが一時的に利用できなくなっても許容範囲であり、最悪の場合でも検索結果が古くなるだけで読み取りは可能です。

<p align="center"><img src="/img/docs/replication-architecture/replication-high-availability.png" alt="高可用性" width="75%"/></p>

高可用性は次の設定例で示せます。  
1. Write `ALL`, Read `ONE`  
   書き込み時は `ALL` ノードの応答が必要なため高可用性はありません。読み取り時は `ONE` であるため、すべてのノードがダウンしても 1 つ残っていれば読み取り操作が可能です。  
2. Write `QUORUM`, Read `QUORUM` (n/2+1)  
   少数のノードがダウンしても過半数が稼働していれば読み取りと書き込みの両方が可能です。  
3. Write `ONE`, Read `ONE`  
   もっとも可用性が高い構成です。 1 ノードを除いてすべてがダウンしても読み取り・書き込みが可能です。ただし、この非常に高い可用性は低い整合性保証と表裏一体です。結果整合性のため、アプリケーション側で一時的なデータの古さに対応できる必要があります。

## スループット（読み取り）の向上

多数のユーザー向けアプリケーションを構築しており、 Weaviate インスタンスに多くの読み取りリクエストが発生する場合、データベースは高いスループットをサポートする必要があります。スループットは QPS（Queries Per Second）で測定します。データベースにサーバーノードを追加するとスループットも比例して増加します。ノード数が増えるほど、システムが処理できるユーザー（読み取り操作）数も増えます。つまり、 Weaviate をレプリケートするとスループットが向上します。

読み取りの整合性レベルを低く（例： `ONE`）設定すると、レプリケーションファクター（サーバーノード数）を増やすことでスループットは線形に向上します。たとえば読み取り整合性が `ONE` で、 1 ノードあたり 10,000 QPS を達成できる場合、 3 レプリカノードの構成では 30,000 QPS が見込めます。

<p align="center"><img src="/img/docs/replication-architecture/replication-increased-throughput.png" alt="スループットの向上" width="75%"/></p>

## ゼロダウンタイムアップグレード

レプリケーションがない場合、 Weaviate インスタンスを更新するとダウンタイムが発生します。単一ノードは停止・アップデート・再起動を経て再びサービス可能になるまで待つ必要があります。レプリケーションを行うと、ローリングアップデートでアップグレードが実施され、同時に停止するのは最大 1 ノードとなり、ほかのノードは引き続きトラフィックを処理できます。

例として、 Weaviate のバージョンを v1.19 から v1.20 へ更新する場合を考えます。レプリケーションがないと次のようなダウンタイムが発生します。  
1. ノードがトラフィックを処理中  
2. ノードを停止、リクエスト不可  
3. ノードイメージを新しいバージョンへ差し替え  
4. ノードを再起動  
5. ノードが準備完了まで待機  
6. ノードが再びトラフィックを処理

ステップ 2 から 6 までは Weaviate サーバーがリクエストを受け付けられず、ユーザー体験が損なわれます。

レプリケーション（例：レプリケーションファクター 3）があれば、 Weaviate のバージョンアップグレードはローリングアップデートで行われ、同時に停止するのは最大 1 ノードです。  
1. 3 ノードすべてがトラフィックを処理中  
2. ノード 1 を置き換え、ノード 2 と 3 がトラフィックを処理  
3. ノード 2 を置き換え、ノード 1 と 3 がトラフィックを処理  
4. ノード 3 を置き換え、ノード 1 と 2 がトラフィックを処理  

<p align="center"><img src="/img/docs/replication-architecture/replication-zero-downtime.gif" alt="ゼロダウンタイムアップグレード" width="75%"/></p>

## 地域的近接性

ユーザーが異なる地域（例：アイスランドとオーストラリアのような遠距離）にいる場合、データベースサーバーとユーザー間の物理距離のため、すべてのユーザーに低レイテンシを保証するのは困難です。データベースサーバーは 1 か所にしか配置できないため、どこに設置するかという課題が生じます。  
1. オプション 1 - クラスターを中間地点に配置（例：インド）<br/>
   アイスランドとインド、オーストラリアとインド間でデータが往復するため、すべてのユーザーが比較的高いレイテンシを被ります。

    <p align="center"><img src="/img/docs/replication-architecture/replication-regional-proximity-1.png" alt="地理的中間地点にクラスターを配置" width="75%"/></p>

2. オプション 2 - クラスターを一方のユーザーグループに近づける（例：アイスランド）<br/>
   アイスランドのユーザーは非常に低レイテンシになりますが、オーストラリアのユーザーはデータ伝送距離が長くなるため高レイテンシを経験します。

   データクラスタを 2 つの地理的ロケーションにレプリケートできる場合、別の選択肢が生まれます。これを Multi-Datacenter（Multi-DC）レプリケーションと呼びます。  
3. オプション 3 - アイスランドとオーストラリアの双方にサーバークラスターを持つ Multi-DC レプリケーション<br/>
   アイスランドとオーストラリアのユーザーはそれぞれローカルクラスターからサービスを受けるため、双方が低レイテンシを享受できます。

    <p align="center"><img src="/img/docs/replication-architecture/replication-regional-proximity-3.png" alt="Multi-DC レプリケーション" width="75%"/></p>

Multi-DC レプリケーションには、データが複数の物理ロケーションに冗長化されるという追加メリットもあります。非常にまれですがデータセンター全体がダウンしても、別のロケーションからデータを提供できます。

:::note
Regional Proximity はレプリケーションの Multi-Datacenter 機能に依存します。関心のある方は[こちら](https://github.com/weaviate/weaviate/issues/2436)で投票できます。
:::

## 質問とフィードバック

import DocsFeedback from '/_includes/docs-feedback.mdx';

<DocsFeedback/>