---
title: キーワード検索
description: 基本的なクエリ、検索オペレーター、スコアリング、プロパティの指定、重み付け、トークン化、フィルタリング、およびファジーマッチングを扱う Weaviate の BM25 キーワード検索のドキュメントです。
sidebar_position: 40
image: og/docs/howto.jpg
# tags: ['how to', 'similarity search']
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import FilteredTextBlock from '@site/src/components/Documentation/FilteredTextBlock';
import PyCode from '!!raw-loader!/\_includes/code/howto/search.bm25.py';
import PyCodeV3 from '!!raw-loader!/\_includes/code/howto/search.bm25-v3.py';
import TSCode from '!!raw-loader!/\_includes/code/howto/search.bm25.ts';
import TSCodeLegacy from '!!raw-loader!/\_includes/code/howto/search.bm25-v2.ts';
import GoCode from '!!raw-loader!/\_includes/code/howto/go/docs/mainpkg/search-bm25_test.go';
import JavaCode from '!!raw-loader!/\_includes/code/howto/java/src/test/java/io/weaviate/docs/search/KeywordSearchTest.java';
import GQLCode from '!!raw-loader!/\_includes/code/howto/search.bm25.gql.py';

`Keyword` 検索（「 BM25 (Best match 25) 」または「スパース ベクトル」検索とも呼ばれます）は、最も高い BM25F スコアを持つオブジェクトを返します。

## 基本的な BM25 検索

BM25 キーワード検索を使用するには、検索文字列を定義します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# BM25BasicPython"
      endMarker="# END BM25BasicPython"
      language="python"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25BasicPython"
      endMarker="# END BM25BasicPython"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START Basic"
      endMarker="// END Basic"
      language="js"
    />
  </TabItem>

   <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START Basic"
      endMarker="// END Basic"
      language="tsv2"
    />
  </TabItem>

   <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START Basic"
      endMarker="// END Basic"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START Basic"
      endMarker="// END Basic"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25BasicGraphQL"
      endMarker="# END BM25BasicGraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>レスポンス例</summary>

レスポンスは次のようになります。

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# Expected BM25Basic results"
  endMarker="# END Expected BM25Basic results"
  language="json"
/>

</details>

## 検索オペレーター

:::info `v1.31` で追加
:::

検索オペレーターは、返されるオブジェクトに含まれている必要があるクエリの [トークン](#set-tokenization) の最小数を定義します。使用できるオプションは `and` と `or`（デフォルト）です。

### `or`

`or` オペレーターを使用すると、検索では検索文字列内のトークンのうち少なくとも `minimumOrTokensMatch` を含むオブジェクトが返されます。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START BM25OperatorOrWithMin"
      endMarker="# END BM25OperatorOrWithMin"
      language="python"
    />
  </TabItem>
  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={GQLCode}
      startMarker="# START BM25OperatorOrWithMin"
      endMarker="# END BM25OperatorOrWithMin"
      language="python"
    />
  </TabItem>
</Tabs>


### `and`

`and` 演算子を使用すると、検索文字列に含まれるすべてのトークンを含むオブジェクトが返されます。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START BM25OperatorAnd"
      endMarker="# END BM25OperatorAnd"
      language="python"
    />
  </TabItem>
  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={GQLCode}
      startMarker="# START BM25OperatorAnd"
      endMarker="# END BM25OperatorAnd"
      language="python"
    />
  </TabItem>
</Tabs>

## BM25F スコアの取得

返された各オブジェクトについて、 BM25F `score` 値を取得できます。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# BM25WithScorePython"
      endMarker="# END BM25WithScorePython"
      language="python"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithScorePython"
      endMarker="# END BM25WithScorePython"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START Score"
      endMarker="// END Score"
      language="js"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START Score"
      endMarker="// END Score"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START Score"
      endMarker="// END Score"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START Score"
      endMarker="// END Score"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithScoreGraphQL"
      endMarker="# END BM25WithScoreGraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>例のレスポンス</summary>

レスポンス例は次のとおりです:

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# Expected BM25WithScore results"
  endMarker="# END Expected BM25WithScore results"
  language="json"
/>

</details>

## 選択したプロパティのみの検索

キーワード検索をオブジェクトのプロパティの一部だけに限定できます。この例では、 BM25 検索は `question` プロパティのみを使用して BM25F スコアを生成します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# BM25WithPropertiesPython"
      endMarker="# END BM25WithPropertiesPython"
      language="python"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithPropertiesPython"
      endMarker="# END BM25WithPropertiesPython"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START Properties"
      endMarker="// END Properties"
      language="js"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START Properties"
      endMarker="// END Properties"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START Properties"
      endMarker="// END Properties"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START Properties"
      endMarker="// END Properties"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithPropertiesGraphQL"
      endMarker="# END BM25WithPropertiesGraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>例のレスポンス</summary>

レスポンス例は次のとおりです:

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# Expected BM25WithProperties results"
  endMarker="# END Expected BM25WithProperties results"
  language="json"
/>

</details>



## 重み付けによるプロパティのブースト

各プロパティが全体の BM25F スコアに与える影響度に重みを付けられます。次の例では、`question` プロパティを 2 倍にブーストし、`answer` プロパティは変更しません。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# BM25WithBoostedPropertiesPython"
      endMarker="# END BM25WithBoostedPropertiesPython"
      language="python"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithBoostedPropertiesPython"
      endMarker="# END BM25WithBoostedPropertiesPython"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START Boost"
      endMarker="// END Boost"
      language="js"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START Boost"
      endMarker="// END Boost"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START Boost"
      endMarker="// END Boost"
      language="java"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START Boost"
      endMarker="// END Boost"
      language="go"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithBoostedPropertiesGraphQL"
      endMarker="# END BM25WithBoostedPropertiesGraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>レスポンス例</summary>

レスポンスは次のようになります。

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# Expected BM25WithBoostedProperties results"
  endMarker="# END Expected BM25WithBoostedProperties results"
  language="json"
/>

</details>

## トークナイゼーションの設定

BM25 クエリ文字列は、転置インデックスでオブジェクト検索に使用される前に [トークン化](../config-refs/collections.mdx#tokenization) されます。

[各プロパティ](../manage-collections/vector-config.mdx#property-level-settings) のコレクション定義で、トークナイゼーション方式を指定する必要があります。

import TknPyCode from '!!raw-loader!/\_includes/code/howto/manage-data.collections.py';
import TknPyCodeV3 from '!!raw-loader!/\_includes/code/howto/manage-data.collections-v3.py';
import TknTsCode from '!!raw-loader!/\_includes/code/howto/manage-data.collections.ts';
import TknTsCodeLegacy from '!!raw-loader!/\_includes/code/howto/manage-data.collections-v2.ts';

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={TknPyCode}
      startMarker="# START PropModuleSettings"
      endMarker="# END PropModuleSettings"
      language="py"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={TknPyCodeV3}
      startMarker="# START PropModuleSettings"
      endMarker="# END PropModuleSettings"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TknTsCode}
      startMarker="// START PropModuleSettings"
      endMarker="// END PropModuleSettings"
      language="ts"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TknTsCodeLegacy}
      startMarker="// START PropModuleSettings"
      endMarker="// END PropModuleSettings"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START PropModuleSettings"
      endMarker="// END PropModuleSettings"
      language="java"
    />
  </TabItem>
</Tabs>

:::tip トークナイゼーションとファジーマッチング

ファジーマッチングやタイプミス許容を行う場合は、`trigram` トークナイゼーションを使用してください。詳細は上記の [ファジーマッチングのセクション](#fuzzy-matching) を参照してください。

:::

## `limit` と `offset`

`limit` を使用して、返すオブジェクトの最大数を固定で設定します。

任意で `offset` を使用して結果をページネーションできます。

<Tabs groupId="languages">
  <TabItem value="py" label="Python クライアント v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START limit Python"
      endMarker="# END limit Python"
      language="py"
    />
  </TabItem>

  <TabItem value="py3" label="Python クライアント v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# START limit Python"
      endMarker="# END limit Python"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS クライアント v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START limit"
      endMarker="// END limit"
      language="ts"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS クライアント v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START limit"
      endMarker="// END limit"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START limit"
      endMarker="// END limit"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START limit"
      endMarker="// END limit"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# START limit GraphQL"
      endMarker="# END limit GraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

## 結果グループの制限

クエリとの距離が近いグループごとに結果を制限するには、[`autocut`](../api/graphql/additional-operators.md#autocut) フィルターを使用して返すグループ数を指定します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python クライアント v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START autocut Python"
      endMarker="# END autocut Python"
      language="py"
    />
  </TabItem>

  <TabItem value="py3" label="Python クライアント v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# START autocut Python"
      endMarker="# END autocut Python"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS クライアント v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START autocut"
      endMarker="// END autocut"
      language="ts"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS クライアント v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START autocut"
      endMarker="// END autocut"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START autocut"
      endMarker="// END autocut"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START autocut"
      endMarker="// END autocut"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# START autocut GraphQL"
      endMarker="# END autocut GraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>レスポンス例</summary>

The response is like this:

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# START Expected autocut results"
  endMarker="# END Expected autocut results"
  language="json"
/>

</details>


## 結果のグループ化

:::info `v1.25` で追加
:::

検索結果をグループ化するための基準を定義します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# START BM25GroupByPy4"
      endMarker="# END BM25GroupByPy4"
      language="py"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START BM25GroupBy"
      endMarker="// END BM25GroupBy"
      language="java"
    />
  </TabItem>
</Tabs>

<details>
  <summary>Example response</summary>

レスポンスは次のようになります:

```
'Jeopardy!'
'Double Jeopardy!'
```

</details>

## 結果のフィルター

より具体的な結果を得るには [`filter`](../api/graphql/filters.md) を使用して検索範囲を絞り込みます。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={PyCode}
      startMarker="# BM25WithFilterPython"
      endMarker="# END BM25WithFilterPython"
      language="python"
    />
  </TabItem>

  <TabItem value="py3" label="Python Client v3">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithFilterPython"
      endMarker="# END BM25WithFilterPython"
      language="pyv3"
    />
  </TabItem>

  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TSCode}
      startMarker="// START Filter"
      endMarker="// END Filter"
      language="js"
    />
  </TabItem>

  <TabItem value="js2" label="JS/TS Client v2">
    <FilteredTextBlock
      text={TSCodeLegacy}
      startMarker="// START Filter"
      endMarker="// END Filter"
      language="tsv2"
    />
  </TabItem>

  <TabItem value="go" label="Go">
    <FilteredTextBlock
      text={GoCode}
      startMarker="// START Filter"
      endMarker="// END Filter"
      language="go"
    />
  </TabItem>

  <TabItem value="java" label="Java">
    <FilteredTextBlock
      text={JavaCode}
      startMarker="// START Filter"
      endMarker="// END Filter"
      language="java"
    />
  </TabItem>

  <TabItem value="graphql" label="GraphQL">
    <FilteredTextBlock
      text={PyCodeV3}
      startMarker="# BM25WithFilterGraphQL"
      endMarker="# END BM25WithFilterGraphQL"
      language="graphql"
    />
  </TabItem>
</Tabs>

<details>
  <summary>Example response</summary>

レスポンスは次のようになります:

<FilteredTextBlock
  text={PyCodeV3}
  startMarker="# Expected BM25WithFilter results"
  endMarker="# END Expected BM25WithFilter results"
  language="json"
/>

</details>

### トークン化

import TokenizationNote from '/\_includes/tokenization.mdx'

<TokenizationNote />

## ファジー マッチング

[`trigram` トークナイゼーション](../config-refs/collections.mdx#tokenization) を使用すると、BM25 検索でファジー マッチングとタイプ ミス許容を有効にできます。この手法ではテキストを 3 文字が重なるシーケンスに分割するため、綴りの誤りや表記揺れがあっても BM25 が一致を見つけられます。

多くのトリグラムを共有するため、完全に一致しない文字列同士でも一致させることができます。

- `"Morgn"` と `"Morgan"` は `"org", "rga", "gan"` のようなトリグラムを共有します

コレクション作成時に、プロパティ レベルでトークナイゼーションを `trigram` に設定します。

<Tabs groupId="languages">
  <TabItem value="py" label="Python Client v4">
    <FilteredTextBlock
      text={TknPyCode}
      startMarker="# START TrigramTokenization"
      endMarker="# END TrigramTokenization"
      language="py"
    />
  </TabItem>
  <TabItem value="js" label="JS/TS Client v3">
    <FilteredTextBlock
      text={TknTsCode}
      startMarker="// START TrigramTokenization"
      endMarker="// END TrigramTokenization"
      language="ts"
    />
  </TabItem>
</Tabs>

:::tip Best practices

- ファジー マッチングが必要なフィールドにのみ、trigram トークナイゼーションを選択的に使用してください。テキスト フィルタリングは単語単位ではなくトリグラム化されたテキストに基づいて行われるため、フィルタリング動作が大きく変わります。  
- 厳密一致が必要なフィールドは、精度を保つために `word` または `field` トークナイゼーションのままにしてください。

:::


## 参考リソース

- [Weaviate への接続](../connections/index.mdx)
- [API リファレンス: Search operators # BM25](../api/graphql/search-operators.md#bm25)
- [リファレンス: トークナイゼーション オプション](../config-refs/collections.mdx#tokenization)
- [Weaviate Academy: トークナイゼーション](../../academy/py/tokenization/index.md)

## ご質問とフィードバック

import DocsFeedback from '/\_includes/docs-feedback.mdx';

<DocsFeedback/>

