---
title: データのインポート
description: マルチモーダルデータコレクションへのデータインポート
---

import Tabs from '@theme/Tabs';  
import TabItem from '@theme/TabItem';  
import FilteredTextBlock from '@site/src/components/Documentation/FilteredTextBlock';  
import PyCode from '!!raw-loader!../_snippets/102_collection.py';  

## <i class="fa-solid fa-code"></i> コード

この例では、映画データをコレクションにインポートします。

<FilteredTextBlock
  text={PyCode}
  startMarker="# BatchImportData"
  endMarker="# END BatchImportData"
  language="py"
/>

コードの内容:
- ソースのテキストと画像データを読み込みます  
- コレクションを取得します  
- バッチャー（ `batch` ）オブジェクトを用いたコンテキストマネージャーに入ります  
- データをループ処理し、次を行います:  
    - テキストに対応する画像を探します  
    - 画像を base64 に変換します  
    - オブジェクトをバッチャーに追加します  
- インポートエラーを出力します  

## <i class="fa-solid fa-chalkboard"></i> コードの説明

### <i class="fa-solid fa-chalkboard"></i> 準備

まず、requests ライブラリを使用してソースからデータを読み込みます。ここではテキストデータを含む JSON ファイルとポスター画像を含む Zip ファイルです。テキストデータは Pandas DataFrame に変換して操作しやすくし、画像は Zip ファイルから展開します。

次に、コレクションと対話できるように `client.collections.get` を使用してコレクションオブジェクトを作成します。

### <i class="fa-solid fa-chalkboard"></i> バッチコンテキストマネージャー

`batch` オブジェクトはコンテキストマネージャーであり、オブジェクトをバッチャーへ追加できます。大量のデータをインポートする際に、バッチサイズの管理や送信タイミングの複雑さを抽象化できるため便利です。

<FilteredTextBlock
  text={PyCode}
  startMarker="# Enter context manager"
  endMarker="# Loop through the data"
  language="py"
/>

この例では `.fixed_size()` メソッドを使用してバッチあたりのオブジェクト数を設定するバッチャーを作成しています。その他にも、分毎のオブジェクト数を指定する `.rate_limit()` や、インポート中に自動でバッチサイズを調整する `.dynamic()` などのバッチャータイプがあります。

### <i class="fa-solid fa-chalkboard"></i> バッチャーへのデータ追加

#### データ型の変換

データは文字列から Weaviate に適した型へ変換されます。たとえば `release_date` は datetime オブジェクトに、`genre_ids` は整数のリストに変換します。

<FilteredTextBlock
  text={PyCode}
  startMarker="# Convert data types"
  endMarker="# Convert image to base64"
  language="py"
/>

画像データを `BLOB` データ型として保存するため、画像を base64 に変換します。

<FilteredTextBlock
  text={PyCode}
  startMarker="# Convert image to base64"
  endMarker="# Build the object payload"
  language="py"
/>

#### オブジェクトをバッチャーに追加

次にデータをループ処理し、各オブジェクトをバッチャーへ追加します。`batch.add_object` メソッドでオブジェクトを追加すると、バッチャーは指定されたタイプに従ってバッチを送信します。

<FilteredTextBlock
  text={PyCode}
  startMarker="# Build the object payload"
  endMarker="# Batcher automatically sends batches"
  language="py"
/>

### <i class="fa-solid fa-chalkboard"></i> エラー処理

バッチには複数のオブジェクトが含まれるため、一部のオブジェクトがインポートに失敗する可能性があります。バッチャーはこれらのエラーを保持します。

エラーを出力することで原因を確認し、例外を発生させるなどの処理を行えます。この例では、単にエラーを出力しています。

<FilteredTextBlock
  text={PyCode}
  startMarker="# Check for failed objects"
  endMarker="finally"
  language="py"
/>

新しいコンテキストマネージャーに入るとエラーリストはクリアされるため、新しいバッチャーを初期化する前にエラー処理を行う必要があります。

## <i class="fa-solid fa-square-chevron-right"></i> ベクトルの生成元

バッチャーがキューを Weaviate に送信すると、オブジェクトはコレクション（ここでは映画コレクション）に追加されます。

コレクションにはベクトライザーモジュールが設定されており、ここではベクトルを指定していません。そのため、Weaviate は指定されたベクトライザーを使用してデータからベクトル埋め込みを生成します。

## 質問とフィードバック

import DocsFeedback from '/_includes/docs-feedback.mdx';  

<DocsFeedback/>