---
title: ハイブリッド検索
description: Weaviate でハイブリッドクエリを使用して、 vector とキーワード検索戦略を組み合わせ高精度を実現します。
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import FilteredTextBlock from '@site/src/components/Documentation/FilteredTextBlock';
import PythonCodeExample from '!!raw-loader!./_snippets/20_hybrid.py';


import imageUrl from '../../tmp_images/academy_placeholder.jpg';

<!-- TODO - add info on fusion algorithms -->

[//]: # (<img src={imageUrl} alt="Image alt" width="75%"/>)

## <i class="fa-solid fa-square-chevron-right"></i> 概要

ハイブリッド検索は、先ほど学習した `bm25` 検索と vector 検索を組み合わせ、両方の結果を統合したランキングを生成します。  

vector 検索またはキーワード検索だけでは期待どおりの結果が得られない場合に、ハイブリッド検索が役立ちます。たとえば、 vector 検索だけでは無関係な結果が多すぎる場合に、特定のキーワードで重み付けをして結果を調整したい場合などです。

## <i class="fa-solid fa-square-chevron-right"></i> `hybrid` クエリ

### <i class="fa-solid fa-chalkboard"></i> 仕組み

ハイブリッド検索は、 `bm25` 検索結果と vector 検索結果を結合して動作します。具体的には、各結果の BM25F 検索ランキングと vector 検索ランキングを組み合わせて評価します。  

各結果について、 BM25F ランキングの逆数と vector 検索ランキングを合計し、必要に応じて `alpha` の重み付けを適用して最終スコアを算出します。最終スコアによって結果が並べ替えられます。

この手法により、どちらか一方の検索で高評価を得た結果が優遇されます。例として、次の 5 件の結果を考えてみましょう。

- Result 1: BM25F ranking = 5, vector search ranking = 1 -> 合計スコア: 1.2
- Result 2: BM25F ranking = 4, vector search ranking = 2 -> 合計スコア: 0.75
- Result 3: BM25F ranking = 3, vector search ranking = 3 -> 合計スコア: 0.67
- Result 4: BM25F ranking = 2, vector search ranking = 4 -> 合計スコア: 0.75
- Result 5: BM25F ranking = 1, vector search ranking = 5 -> 合計スコア: 1.2

この例では、いずれか一方で高評価だった 1 と 5 が上位に来ています。一方、両方で中程度だった 3 は最下位になっています。

つまり、ハイブリッド検索では片方の検索で高評価を得た結果が上位に来やすく、平均的な結果は下位に配置されます。

### <i class="fa-solid fa-code"></i> `hybrid` クエリ構文

ハイブリッドクエリは次のように記述します。各ハイブリッドクエリは次の要件を持ちます。

- **必須**: 任意長の query 文字列  
- **任意**: 検索対象の `properties`  
- **任意**: `alpha` 値  
- **任意**: 検索対象の `vector`  
- **任意**: 各結果の `score` および `explainScore` の取得

<Tabs groupId="languages">
<TabItem value="py" label="Python">
<FilteredTextBlock
  text={PythonCodeExample}
  startMarker="# GenericHybridQuery"
  endMarker="# END GenericHybridQuery"
  language="py"
/>
</TabItem>
</Tabs>

上記のクエリは、クエリ文字列 `"food"` に基づき、 BM25F スコアと `nearText` 類似度で上位 3 件のオブジェクトを返します。 BM25F スコアの計算では `question` と `answer` プロパティを検索します（オブジェクトのベクトルは `properties` の指定による影響を受けません）。

<details>
  <summary><i class="fa-solid fa-radar"></i> JSON レスポンスを表示</summary>

<FilteredTextBlock
  text={PythonCodeExample}
  startMarker="# Expected GenericHybridQuery results"
  endMarker="# END Expected GenericHybridQuery results"
  language="py"
/>

</details>

## <i class="fa-solid fa-square-chevron-right"></i> `hybrid` 検索パラメーター

`hybrid` 検索には複数のパラメーターがあり、その一部は `bm25` 検索で既に登場しました。  

`query` と `properties` は `bm25` 検索と同じですが、現在ハイブリッド検索では boost パラメーターはサポートされていません。一方、ハイブリッド検索固有のパラメーターも存在します。

[//]: # (### <i class="fa-solid fa-code"></i> `vector`)

[//]: # ()
[//]: # (The `vector` parameter is optional. If you do not include a `vector` parameter, the `hybrid` search will generate a vector from the query string. If you do include a `vector` parameter, the `hybrid` search will use the vector you provide.)

[//]: # ()
[//]: # (In this way, you may be able to perform a hybrid search where the `bm25` search and the vector search are based on different concepts. For example, you could perform a `bm25` search with the query string `italian`, and have the vector search be based on a vector of `food`.)

[//]: # ()
[//]: # (:::warning)

[//]: # (TODO - complete this section after I get responses on the slack comment/question)

[//]: # (:::)

### <i class="fa-solid fa-code"></i> `alpha`

任意の `alpha` パラメーターは、 BM25 検索ランキングと vector 検索ランキングの重み付けを決定します。指定しない場合は既定値 0.5 が使用され、両者が同等に重み付けされます。  

`alpha` を 1 にすると純粋な vector 検索と同じになり、0 にすると純粋な BM25 検索と同じになります。

:::tip 演習
上のクエリで `alpha` を変化させてみましょう。結果はどう変わりますか？
:::

## <i class="fa-solid fa-square-chevron-right"></i> 復習

<Quiz questions={hybridRankingQuestion} />

### <i class="fa-solid fa-pen-to-square"></i> 復習問題

### <i class="fa-solid fa-lightbulb-on"></i> 重要ポイント

- ハイブリッド検索は `bm25` 検索と vector 検索を組み合わせ、両者の結果からランキングを生成します。  
- vector 検索またはキーワード検索だけでは求める結果が得られない場合に有効です。  
- ハイブリッド検索では、 vector と `bm25` のランキングの逆数を合計して検索結果を並べ替えます。
## 質問とフィードバック

import DocsFeedback from '/_includes/docs-feedback.mdx';

<DocsFeedback/>

import Quiz from '/src/components/Academy/quiz.js'
export const hybridRankingQuestion = [{
  questionText: 'How do hybrid searches order its search results?',
  answerOptions: [
    {
      answerText: 'By multiplying the vector similarity with the BM25 score',
      isCorrect: false,
      feedback: 'It does not do that, unfortunately.',
    },
    {
      answerText: 'By averaging the vector and BM25 search rankings',
      isCorrect: false,
      feedback: 'It does not do that, unfortunately.',
    },
    {
      answerText: 'By summing the inverse of the vector and BM25 rankings',
      isCorrect: true,
      feedback: 'So it has the effect of rewarding results that score high in at least one of the searches.',
    },
  ]
}];